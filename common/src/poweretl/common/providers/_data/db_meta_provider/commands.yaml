get_version: |
  WITH table_exists AS (
    SELECT EXISTS (
      SELECT 1
      FROM system.information_schema.tables
      WHERE 
        table_catalog     = split('{table_version}', '\\.')[0]
        AND table_schema  = split('{table_version}', '\\.')[1]
        AND table_name    = split('{table_version}', '\\.')[2]
    ) AS exists_flag
  )

  SELECT
    CASE
      WHEN exists_flag THEN (SELECT version FROM {table_version})
      ELSE ''
    END AS version,
    
    CASE
      WHEN exists_flag THEN (SELECT step FROM {table_version})
      ELSE 0
    END AS step
  FROM table_exists;


update_version: |
  UPDATE {table_version} SET version = '{version}', step = {step}, updated_at = current_timestamp()

