get_version: |
  BEGIN
    DECLARE sqlStr STRING DEFAULT 'SELECT version, step FROM {table_version}';
    DECLARE tableExists BOOLEAN DEFAULT false;
    SET tableExists = (EXISTS (
      SELECT 1
      FROM system.information_schema.tables
      WHERE 
        table_catalog     = split('{table_version}', '\\.')[0]
        AND table_schema  = split('{table_version}', '\\.')[1]
        AND table_name    = split('{table_version}', '\\.')[2]
    ));

    IF (tableExists=true) THEN
      EXECUTE IMMEDIATE sqlStr;
    ELSE
      SELECT '' AS version, 0 AS step;
    END IF;
  END;


update_version: |
  UPDATE {table_version} SET version = '{version}', step = {step}, updated_at = current_timestamp()

